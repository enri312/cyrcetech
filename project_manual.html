<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyrcetech Project Manual v2.4.0</title>
    <!-- Add Roboto Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background: #fafafa;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            margin-top: 1.5em;
        }

        h1 {
            border-bottom: 3px solid #3498db;
            padding-bottom: 0.3em;
        }

        h2 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        code {
            background-color: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
        }

        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 16px;
            border-radius: 8px;
            overflow: auto;
        }

        pre code {
            background: none;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid #3498db;
            color: #6a737d;
            padding: 0 1em;
            margin: 0;
            background: #f0f7ff;
        }

        img {
            max-width: 100%;
        }

        .mermaid {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #3498db;
            color: white;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .toc {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .toc a {
            color: #3498db;
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

        document.addEventListener('DOMContentLoaded', async () => {
            const markdownContent = `
# Manual del Proyecto Cyrcetech v2.4.0

## Tabla de Contenidos
1. [IntroducciÃ³n](#1-introducciÃ³n)
2. [Diagrama de Contexto](#2-diagrama-de-contexto)
3. [Diagrama de Flujo de Datos (DFD Nivel 1)](#3-diagrama-de-flujo-de-datos-dfd-nivel-1)
4. [Casos de Uso](#4-casos-de-uso)
5. [Diagrama de Clases](#5-diagrama-de-clases)
6. [DiseÃ±o y Arquitectura](#6-diseÃ±o-y-arquitectura)
7. [ImplementaciÃ³n](#7-implementaciÃ³n)
8. [Nuevas Funcionalidades v2.4.0](#8-nuevas-funcionalidades-v240)

---

## 1. IntroducciÃ³n

Cyrcetech es un sistema integral de **GestiÃ³n de Taller de ReparaciÃ³n (SaaS / On-Premise)** diseÃ±ado para administrar Ã³rdenes de servicio, clientes, inventario y facturaciÃ³n. El sistema utiliza una arquitectura hÃ­brida con un Backend centralizado (Spring Boot), un cliente Desktop (JavaFX con Clean Architecture) y un cliente Web (React).

### TecnologÃ­as Clave
| Componente | TecnologÃ­a |
|------------|------------|
| Backend | Java 25, Spring Boot 4.0.0, Spring Security (JWT) |
| Frontend Desktop | JavaFX 25, **Clean Architecture**, Modular |
| Frontend Web | React 19.2 (Vite), Google GenAI SDK |
| Base de Datos | PostgreSQL 18.1 |
| Integraciones | CyrcePDF (PDF), Apache POI (Excel), n8n (AutomatizaciÃ³n) |
| Inteligencia Artificial | **Ollama (Phi4-mini)** (Desktop) / **Google Gemini** (Web) |

---

## 2. Diagrama de Contexto

Representa al sistema como una caja negra mostrando las interacciones con actores externos.

\`\`\`mermaid
graph TB
    subgraph Actores Externos
        Admin["ğŸ‘¨â€ğŸ’¼ Administrador"]
        Tech["ğŸ‘¨â€ğŸ”§ TÃ©cnico"]
        User["ğŸ‘¤ Usuario"]
        Customer["ğŸ§‘â€ğŸ¤â€ğŸ§‘ Cliente"]
        N8N["ğŸ”„ n8n Automation"]
        AI_Local["ğŸ§  Ollama (Phi4-mini)"]
        AI_Cloud["ğŸŒ©ï¸ Google Gemini API"]
    end

    subgraph Sistema Cyrcetech
        SYS["ğŸ”§ Sistema de GestiÃ³n de Taller"]
    end

    Admin -->|"Gestionar Usuarios, AuditorÃ­a, Reportes"| SYS
    Tech -->|"Gestionar Tickets, Clientes, Equipos"| SYS
    User -->|"Crear Tickets, Ver Clientes/Equipos"| SYS
    Customer -->|"Recibir Notificaciones"| SYS
    
    SYS -->|"Reportes Excel/PDF"| Admin
    SYS -->|"Orden de Servicio PDF"| Customer
    SYS -->|"Webhooks"| N8N
    SYS <-->|"DiagnÃ³stico Local"| AI_Local
    SYS <-->|"Asistencia Web"| AI_Cloud
    N8N -->|"Emails AutomÃ¡ticos"| Customer
\`\`\`

---

## 3. Diagrama de Flujo de Datos (DFD Nivel 1)

\`\`\`mermaid
flowchart TB
    subgraph Externos
        E1["ğŸ‘¨â€ğŸ”§ TÃ©cnico / ğŸ‘¤ Usuario"]
        E2["ğŸ‘¨â€ğŸ’¼ Administrador"]
    end

    subgraph Procesos
        P1["1.0 GestiÃ³n Clientes"]
        P2["2.0 GestiÃ³n Equipos"]
        P3["3.0 GestiÃ³n Tickets"]
        P4["4.0 FacturaciÃ³n"]
        P5["5.0 AuditorÃ­a"]
    end

    subgraph Almacenes
        D1[("customers")]
        D2[("equipment")]
        D3[("tickets")]
        D4[("invoices")]
        D5[("audit_logs")]
        D6[("users")]
    end

    E1 --> P1 --> D1
    E1 --> P2 --> D2
    E1 --> P3 --> D3
    E2 --> P4 --> D4
    E2 --> P5 --> D5
    D6 --> P5
    
    P1 & P2 & P3 & P4 --> P5
\`\`\`

---

## 4. Casos de Uso

\`\`\`mermaid
graph LR
    subgraph Actores
        Admin["ğŸ‘¨â€ğŸ’¼ Admin"]
        Tech["ğŸ‘¨â€ğŸ”§ TÃ©cnico"]
        User["ğŸ‘¤ Usuario"]
    end

    subgraph Clientes_Equipos
        UC1["Registrar/Ver Cliente"]
        UC2["Registrar/Ver Equipo"]
        UC3["Exportar Clientes PDF"]
    end

    subgraph Tickets
        UC8["Crear Ticket"]
        UC9["Actualizar Estado"]
        UC11["Exportar Tickets Excel"]
    end

    subgraph Admin_Only
        UC12["Ver AuditorÃ­a"]
        UC13["Gestionar Usuarios"]
        UC14["ConfiguraciÃ³n Sistema"]
    end

    Tech --> UC1 & UC2 & UC8 & UC9
    User --> UC1 & UC2 & UC8
    Admin --> UC1 & UC2 & UC3 & UC8 & UC9 & UC11 & UC12 & UC13 & UC14
\`\`\`

### Matriz de Permisos por Rol (Actualizado v2.4.0)

| AcciÃ³n | Usuario | TÃ©cnico | Admin |
|--------|:-------:|:-------:|:-----:|
| Ver sus propios datos | âœ… | âœ… | âœ… |
| **Ver/Crear Clientes** | âœ… | âœ… | âœ… |
| **Ver/Crear Equipos** | âœ… | âœ… | âœ… |
| **Crear Tickets** | âœ… | âœ… | âœ… |
| Editar Tickets (Estado/DiagnÃ³stico) | âŒ | âœ… | âœ… |
| Ver todos los tickets | âŒ | âœ… | âœ… |
| Ver repuestos/inventario | âŒ | âœ… | âœ… |
| Crear usuarios | âŒ | âŒ | âœ… |
| Ver auditorÃ­a | âŒ | âŒ | âœ… |
| Exportar Excel/PDF | âŒ | âœ… | âœ… |

---

## 5. Diagrama de Clases

\`\`\`mermaid
classDiagram
    class User {
        -String id
        -String username
        -String fullName
        -String email
        -String password
        -Role role
    }

    class Customer {
        -String id
        -String name
        -String taxId
        -String phone
        -LocalDate registrationDate
        -CustomerCategory category
        +getSeniorityDays()
        +getFormattedSeniority()
    }

    class CustomerCategory {
        <<enumeration>>
        NUEVO
        REGULAR
        VIP
        ESPECIAL
    }

    class Equipment {
        -String id
        -String brand
        -String model
        -DeviceType deviceType
        -Customer customer
    }

    class AuditLog {
        -String id
        -String userId
        -String username
        -Role userRole
        -AuditAction action
        -String entityType
        -String details
        -String ipAddress
        -LocalDateTime timestamp
    }

    User "1" -- "*" AuditLog : generates
    Customer "1" *-- "*" Equipment : owns
    Customer "1" -- "*" Ticket : places
    Equipment "1" -- "*" Ticket : subject of
\`\`\`

---

## 6. DiseÃ±o y Arquitectura

### 6.1 Arquitectura Backend (Spring Boot Layers)
El Backend sigue una arquitectura en capas tradicional, robusta y escalable.

\`\`\`mermaid
graph TB
    subgraph "API Layer (Controller)"
        AC[AuthController]
        CC[CustomerController]
        TC[TicketController]
    end

    subgraph "Business Layer (Service)"
        AS[AuthService]
        CS[CustomerService]
        TS[TicketService]
    end

    subgraph "Data Layer (Repository & Entity)"
        AR[UserRepository]
        CR[CustomerRepository]
        TR[TicketRepository]
        DB[("PostgreSQL")]
    end

    AC --> AS
    CC --> CS
    TC --> TS
    AS --> AR
    CS --> CR
    TS --> TR
    AR & CR & TR --> DB
\`\`\`

### 6.2 Arquitectura Frontend Desktop (**Clean Architecture**)
El cliente JavaFX ha sido refactorizado para seguir **Clean Architecture**, desacoplando la UI de la lÃ³gica de negocio y la infraestructura.

\`\`\`mermaid
graph TB
    subgraph "Presentation Layer"
        View["JavaFX Views (.fxml)"]
        ViewModel["View Models"]
    end

    subgraph "Interface Adapter Layer"
        Controller["Controllers"]
        Presenter["Presenters"]
    end

    subgraph "Application Layer (Use Cases)"
        UC_Auth["AuthUseCase"]
        UC_Ticket["CreateTicketUseCase"]
    end

    subgraph "Domain Layer"
        Entity["Entidades del Dominio"]
    end

    subgraph "Infrastructure Layer"
        API["ApiService (Http Client)"]
        Storage["LocalStorage"]
    end

    View --> Controller
    Controller --> UC_Auth & UC_Ticket
    UC_Auth --> Entity
    UC_Auth --> API
    API --> Entity
\`\`\`

### 6.3 Modelo de Datos (ERD)

\`\`\`mermaid
erDiagram
    users ||--o{ audit_logs : generates
    customers ||--o{ equipment : owns
    customers ||--o{ tickets : places
    equipment ||--o{ tickets : subject_of
    tickets ||--o{ invoices : generates

    users {
        uuid id PK
        varchar username UK
        varchar full_name
        varchar email
        varchar password
        varchar role
    }

    customers {
        uuid id PK
        varchar name
        varchar tax_id UK
        varchar phone
        date registration_date
        enum category
    }

    audit_logs {
        uuid id PK
        uuid user_id
        varchar username
        enum user_role
        enum action
        varchar entity_type
        text details
        timestamp timestamp
    }
\`\`\`

---

## 7. ImplementaciÃ³n

### 7.1 Lenguaje y LibrerÃ­as Actualizadas

| Componente | TecnologÃ­a | VersiÃ³n |
|------------|------------|---------|
| **Lenguaje** | Java | 25 |
| **Framework Backend** | Spring Boot | 4.0.0 |
| **PDF Engine** | CyrcePDF (Propia) | 1.0.0 |
| **Frontend Web** | React | 19.2.0 |
| **Web AI SDK** | Google GenAI | 1.30.0 |
| **Desktop AI** | Ollama (Phi4-mini) | Latest |
| **Build Tool** | Gradle | 9.2.1 |

### 7.2 Estructura del Proyecto

\`\`\`text
cyrcetech/
â”œâ”€â”€ backend/                       # Spring Boot (Layered Arch)
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ domain/entity/
â”‚   â”œâ”€â”€ repository/
â”‚   â””â”€â”€ service/
â”‚
â”œâ”€â”€ src/main/java/com/cyrcetech/   # JavaFX Client (Clean Arch)
â”‚   â”œâ”€â”€ app/                       # Entry Point
â”‚   â”œâ”€â”€ entity/                    # Domain Entities
â”‚   â”œâ”€â”€ infrastructure/            # API Implementation
â”‚   â”œâ”€â”€ interface_adapter/         # Controllers
â”‚   â””â”€â”€ usecase/                   # Business Logic
â”‚
â””â”€â”€ Front-end/                     # React Web App
    â”œâ”€â”€ src/components/
    â”œâ”€â”€ src/views/
    â””â”€â”€ package.json
\`\`\`

---

## 8. Nuevas Funcionalidades v2.4.0

### âœ… AutenticaciÃ³n Mejorada
- MigraciÃ³n de login por **Username** en lugar de Email.
- Entidad \`User\` actualizada con campo \`username\` Ãºnico.

### âœ… Permisos de Usuario (Role: USER)
- Acceso habilitado para **Ver y Crear Clientes**.
- Acceso habilitado para **Ver y Crear Equipos**.
- *Nota: Los usuarios estÃ¡ndar siguen restringidos para editar tickets avanzados o ver auditorÃ­a.*

### âœ… Arquitectura Limpia (Frontend Desktop)
- ImplementaciÃ³n de **Clean Architecture** en el cliente JavaFX.
- SeparaciÃ³n clara entre \`interface_adapter\`, \`usecase\`, \`infrastructure\` y \`entity\`.

### âœ… IntegraciÃ³n de IA HÃ­brida
- **Desktop**: Uso de **Ollama** con modelo **Phi4-mini** para diagnÃ³sticos locales offline.
- **Web**: IntegraciÃ³n con **Google Gemini API** para asistencia en la nube.

---

*Generado automÃ¡ticamente por Antigravity AI - Diciembre 2025*
            `;

            // Render Markdown
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = marked.parse(markdownContent);

            // Render Mermaid blocks
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid');
            for (let i = 0; i < mermaidBlocks.length; i++) {
                const block = mermaidBlocks[i];
                const pre = block.parentElement;
                const code = block.textContent;

                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = code;

                pre.replaceWith(div);
            }

            await mermaid.run();
        });
    </script>
</head>

<body>
    <div id="content"></div>
</body>

</html>